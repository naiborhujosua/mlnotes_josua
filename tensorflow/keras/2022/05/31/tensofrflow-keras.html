<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Part 1: Building Deep Learning Models by using Keras and Tensorflow | Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Part 1: Building Deep Learning Models by using Keras and Tensorflow" />
<meta name="author" content="josua naiborhu" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learning how to build simple to complex architecture of deep learning model." />
<meta property="og:description" content="Learning how to build simple to complex architecture of deep learning model." />
<link rel="canonical" href="https://naiborhujosua.github.io/mlnotes_josua/tensorflow/keras/2022/05/31/tensofrflow-keras.html" />
<meta property="og:url" content="https://naiborhujosua.github.io/mlnotes_josua/tensorflow/keras/2022/05/31/tensofrflow-keras.html" />
<meta property="og:site_name" content="Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-05-31T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Part 1: Building Deep Learning Models by using Keras and Tensorflow" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"josua naiborhu"},"dateModified":"2022-05-31T00:00:00-05:00","datePublished":"2022-05-31T00:00:00-05:00","description":"Learning how to build simple to complex architecture of deep learning model.","headline":"Part 1: Building Deep Learning Models by using Keras and Tensorflow","mainEntityOfPage":{"@type":"WebPage","@id":"https://naiborhujosua.github.io/mlnotes_josua/tensorflow/keras/2022/05/31/tensofrflow-keras.html"},"url":"https://naiborhujosua.github.io/mlnotes_josua/tensorflow/keras/2022/05/31/tensofrflow-keras.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/mlnotes_josua/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://naiborhujosua.github.io/mlnotes_josua/feed.xml" title="Blog" /><!-- the google_analytics_id gets auto inserted from the config file -->



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-92096180-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-92096180-1');
</script>


<link rel="shortcut icon" type="image/x-icon" href="/mlnotes_josua/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/mlnotes_josua/">Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/mlnotes_josua/about/">About Me</a><a class="page-link" href="/mlnotes_josua/search/">Search</a><a class="page-link" href="/mlnotes_josua/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Part 1: Building Deep Learning Models by using Keras and Tensorflow</h1><p class="page-description">Learning how to build simple to complex architecture of deep learning model.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-05-31T00:00:00-05:00" itemprop="datePublished">
        May 31, 2022
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">josua naiborhu</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/mlnotes_josua/categories/#tensorflow">tensorflow</a>
        &nbsp;
      
        <a class="category-tags-link" href="/mlnotes_josua/categories/#keras">keras</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="introduction">Introduction</h2>
<blockquote>
  <p>This is just some random notes  by reading <code class="language-plaintext highlighter-rouge">Deep Learning with Python</code> by  Francois Chollet.This book focusses on developing Deep Learning Models using Keras and Tensorflow.
I found this book is very good at explaining Deep learning.I try making notes for important chapters that i think it is essential for improving myself in developing deep learning models. 
I took some source code from the book as a reference.</p>
</blockquote>

<h2 id="different-ways-of-building-models-in-keras">Different ways of building models in Keras</h2>
<ul>
  <li>Sequential model where the the layers are stacked each other to create the DL architecture.</li>
  <li>The functional API where focussing on graph-like model architecture that represents a nice usabilibity and flexibility.</li>
  <li>Model Subclassing where a low level option to write model from scratch.</li>
</ul>

<h2 id="sequential-models">Sequential Models</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span> 
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span> 

<span class="n">model</span> <span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">"relu),
    layers.Dense(10,activation="</span><span class="n">softmax</span><span class="s">")
])
</span></code></pre></div></div>
<p>or</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">"relu))
model.add(layers.Dense(10,activation="</span><span class="n">softmax</span><span class="s">")) 

</span></code></pre></div></div>
<p>We see that sequential model create the 64 multidimensional representation based on input data to create 10 output 
value using softmax activation function to get predicted probabilities. You can check model.summary() 
for looking at the architecture of your model. You can also name the models and layers by dding name parameters in each process in your architecture by using string.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"my_example_model"</span><span class="p">)</span>
<span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">"relu),name="</span><span class="n">my_first_layer</span><span class="s">")
model.add(layers.Dense(10,activation="</span><span class="n">softmax</span><span class="s">",name="</span><span class="n">my_last_layer</span><span class="s">")) 
</span></code></pre></div></div>

<h2 id="functional-api">Functional API</h2>
<p>While sequential model constainst are for simple model that can express models with single input and single output where applying one layer after the other sequentially. 
There is a situation when we face a problem to encounter models with multiple inputs like image and its metadata and multiple output to predict different things about data. 
Imagine you are building a system to rank customer support tickets by priority and route them by departments based on 3 inputs</p>
<ul>
  <li>The title of the ticket(text input)</li>
  <li>The text body of the ticket(text input)</li>
  <li>Any tags added by the user(categorical input encode to one-hot encing)
 and create 2 outputs</li>
  <li>The priority score of the ticket , a scalr between 0-1(Sigmoid ouput)</li>
  <li>The deparment that should handle the ticket (Softax over the set of departments)</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">vocabulary_size</span> <span class="o">=</span><span class="mi">10000</span>
<span class="n">num_tags</span> <span class="o">=</span><span class="mi">100</span>
<span class="n">num_departments</span> <span class="o">=</span><span class="mi">4</span>
<span class="c1"># Define model inputs
</span><span class="n">title</span> <span class="o">=</span><span class="n">keras</span><span class="p">,</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">vocabulary_size</span><span class="p">,),</span><span class="n">name</span><span class="o">=</span><span class="s">"title"</span><span class="p">)</span>
<span class="n">text_body</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">vocabulary_size</span><span class="p">,),</span><span class="n">name</span><span class="o">=</span><span class="s">"text_body"</span><span class="p">)</span>
<span class="n">tags</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_tags</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s">"tags"</span><span class="p">)</span>

<span class="c1">#Combine input features into a single tensor by concatenating them
</span><span class="n">features</span> <span class="o">=</span> <span class="n">layers</span><span class="p">.</span><span class="n">Concatenate</span><span class="p">()([</span><span class="n">title</span><span class="p">,</span><span class="n">text_body</span><span class="p">,</span><span class="n">tags</span><span class="p">])</span>
<span class="n">features</span> <span class="o">=</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">"relu"</span><span class="p">)(</span><span class="n">features</span><span class="p">)</span>

<span class="c1"># Define Model outputs
</span><span class="n">priority</span> <span class="o">=</span> <span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">"sigmoid"</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="s">"priority"</span><span class="p">)(</span><span class="n">features</span><span class="p">)</span>
<span class="n">department</span> <span class="o">=</span> <span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_departments</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">"softmax"</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">"departments"</span><span class="p">)(</span><span class="n">features</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">title</span><span class="p">,</span><span class="n">text_body</span><span class="p">,</span><span class="n">tags</span><span class="p">],</span>
<span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">priority</span><span class="p">,</span><span class="n">department</span><span class="p">])</span>

</code></pre></div></div>
<p>You can see the structure of your model in a nice graph by plotting the moarchitecture by using <code class="language-plaintext highlighter-rouge">keras.utils.plt_model(instances of model object)</code>.The advantage of using functional API is enabling us to do feature extractions that reuse intermediate features from another model. If we want to add another output to the precious model by estimating how long a given issue ticket will take to ressolve by difficulty rating(quick,medium,difficult). we dont need to recreate the model from scratch. We can start fro intermediate features of previous model</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">features</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">output</span>
<span class="n">difficulty</span> <span class="o">=</span> <span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">activation</span> <span class="o">=</span><span class="s">"softmax"</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">"difficulty"</span><span class="p">)(</span><span class="n">features</span><span class="p">)</span>

<span class="n">new_model</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span> <span class="o">=</span><span class="p">[</span><span class="n">title</span><span class="p">,</span><span class="n">text_body</span><span class="p">,</span><span class="n">tags</span><span class="p">],</span>
<span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">priority</span><span class="p">,</span><span class="n">department</span><span class="p">,</span><span class="n">difficulty</span><span class="p">])</span>

<span class="n">keras</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">plot_model</span><span class="p">(</span><span class="n">new_model</span><span class="p">,</span><span class="s">"updated_ticket_classifier.png"</span><span class="p">,</span><span class="n">show_shapes</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>
<h2 id="subclassing-model-class">Subclassing Model class</h2>
<p>This is the advanced of building model pattern by subclassing Layer class to create custom layers.
This is like subclassing nn.Model in pytorch(if you experienced in pytorch)</p>

<ul>
  <li><strong>init</strong> for defining the layers the model will use</li>
  <li>call() for defining the forward pass of the model by reusing previously layers created.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CustomerTicketModel</span><span class="p">(</span><span class="n">keras</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">num_departments</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">concat_layer</span> <span class="o">=</span> <span class="n">layers</span><span class="p">.</span><span class="n">Concatenate</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">mixing_layer</span> <span class="o">=</span> <span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">"relu"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">priority_scorer</span> <span class="o">=</span> <span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">"sigmoid"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">departments_classifier</span> <span class="o">=</span> <span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_departments</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">"sofmax"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inputs</span><span class="p">):</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s">"title"</span><span class="p">]</span>
        <span class="n">text_body</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s">"text_body"</span><span class="p">]</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s">"tags"</span><span class="p">]</span>

        <span class="n">features</span> <span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">concat_layer</span><span class="p">[</span><span class="n">title</span><span class="p">,</span><span class="n">text_body</span><span class="p">,</span><span class="n">tags</span><span class="p">]</span>
        <span class="n">features</span> <span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">mixing_layer</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

        <span class="n">priority</span> <span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">priority_scorer</span><span class="p">)(</span><span class="n">features</span><span class="p">)</span>
        <span class="n">department</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">department_classifier</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">priority</span><span class="p">,</span><span class="n">department</span>


<span class="n">model</span> <span class="o">=</span><span class="n">CustomerTicketModel</span><span class="p">(</span><span class="n">num_departments</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">priority</span><span class="p">,</span><span class="n">department</span> <span class="o">=</span><span class="n">model</span><span class="p">({</span><span class="s">"title"</span><span class="p">:</span><span class="n">title_data</span><span class="p">,</span><span class="s">"text_body"</span><span class="p">:</span><span class="n">text_body_data</span><span class="p">,</span><span class="s">"tags"</span><span class="p">:</span><span class="n">ttags_data</span><span class="p">})</span>

 <span class="c1">## Do compile(),fit(),evalueate and predict() as usual.
</span> 
</code></pre></div></div>

<h2 id="writing-own-callbacks-lossearlystoppingmodelcheckpoint">Writing own callbacks (loss,EarlyStopping,ModelCheckPoint)</h2>

<p>There are a few methods available in keras.callbacks.Callback class</p>
<ul>
  <li>on_epoch_begin(epoch,logs) for calling at the start of every epoch</li>
  <li>on_epoch_end(epoch,logs) for calling at the end of every epoch</li>
  <li>on_batch_begin(batch,logs)  for calling tight before processing each batch</li>
  <li>on_batch_end(batch,logs) for calling right after processing each batch</li>
  <li>on_train_begin(logs) for calling at the start of training</li>
  <li>on_train_end(logs) for calling at the end of training</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
 
<span class="c1">## Transform Training fit() ModelCheckPoint and EarlyStopping
</span><span class="sb">``</span><span class="err">`</span><span class="n">python</span> 
<span class="kn">from</span> <span class="nn">tensorflow.keras.datasets</span> <span class="kn">import</span> <span class="n">mnist</span>

<span class="k">def</span> <span class="nf">get_mnist_model</span><span class="p">():</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">,))</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">"relu"</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">features</span> <span class="o">=</span><span class="n">layers</span><span class="p">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">features</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s">"softmax"</span><span class="p">)(</span><span class="n">features</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="n">outputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>


<span class="p">(</span><span class="n">images</span><span class="p">,</span><span class="n">labels</span><span class="p">),(</span><span class="n">test_images</span><span class="p">,</span><span class="n">test_labels</span><span class="p">)</span> <span class="o">=</span><span class="n">mnist</span><span class="p">.</span><span class="n">load_data</span><span class="p">()</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="p">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">60000</span><span class="p">,</span><span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">)).</span><span class="n">astype</span><span class="p">(</span><span class="s">"float32"</span><span class="p">)</span><span class="o">/</span><span class="mi">255</span>
<span class="n">test_images</span> <span class="o">=</span><span class="n">test_images</span><span class="p">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">10000</span><span class="p">,</span><span class="mi">28</span><span class="o">*</span><span class="mi">28</span><span class="p">)).</span><span class="n">astype</span><span class="p">(</span><span class="s">"float32"</span><span class="p">)</span><span class="o">/</span><span class="mi">255</span>
<span class="n">train_images</span><span class="p">,</span><span class="n">val_images</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="mi">10000</span><span class="p">:],</span><span class="n">images</span><span class="p">[:</span><span class="mi">10000</span><span class="p">]</span>
<span class="n">train_labels</span><span class="p">,</span><span class="n">val_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="mi">10000</span><span class="p">:],</span><span class="n">labels</span><span class="p">[:</span><span class="mi">10000</span><span class="p">]</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">get_mnist_model</span><span class="p">()</span>
<span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s">"rmsprop"</span><span class="p">,</span><span class="n">loss</span><span class="o">=</span><span class="s">"sparse_categorical_crossentropy"</span><span class="p">,</span>
<span class="n">metrics</span> <span class="o">=</span><span class="p">[</span><span class="s">"accuracy"</span><span class="p">])</span>

<span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_images</span><span class="p">,</span><span class="n">train_labels</span><span class="p">,</span><span class="n">epoch</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">validation_data</span><span class="o">=</span><span class="p">[</span><span class="n">test_images</span><span class="p">,</span><span class="n">test_labels</span><span class="p">])</span>
<span class="n">test_metrics</span> <span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_images</span><span class="p">,</span><span class="n">val_label</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_images</span><span class="p">)</span>

<span class="n">callbacks_list</span> <span class="o">=</span><span class="p">[</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">callbacks</span><span class="p">.</span><span class="n">EarlyStopping</span><span class="p">(</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s">"val_accuracy"</span><span class="p">,</span>
    <span class="n">patience</span><span class="o">=</span><span class="mi">2</span><span class="p">,),</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">callbacks</span><span class="p">.</span><span class="n">ModelCheckPoint</span><span class="p">(</span>
        <span class="n">filepath</span><span class="o">=</span><span class="s">"checkpoint_path.keras"</span><span class="p">,</span>
        <span class="n">monitor</span> <span class="o">=</span><span class="s">"val_loss"</span><span class="p">,</span>
        <span class="n">save_best_only</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
<span class="p">]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">get_mnist_model</span><span class="p">()</span>
<span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s">"rmsprop"</span><span class="p">,</span>
              <span class="n">loss</span> <span class="o">=</span><span class="s">"sparse_categorical_crossentropy"</span><span class="p">,</span>
              <span class="n">metrics</span> <span class="o">=</span><span class="p">[</span><span class="s">"accuracy"</span><span class="p">])</span>
<span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_images</span><span class="p">,</span><span class="n">train_labels</span><span class="p">,</span><span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">calbacks</span><span class="o">=</span><span class="n">callbacks_list</span><span class="p">,</span>
<span class="n">validation_data</span><span class="o">=</span><span class="p">[</span><span class="n">val_images</span><span class="p">,</span><span class="n">val_labels</span><span class="p">])</span>

<span class="c1">#Load the model 
</span><span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="n">load_model</span><span class="p">(</span><span class="s">"checkpoint_path.keras"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">lossHistory</span><span class="p">(</span><span class="n">keras</span><span class="p">.</span><span class="n">callbacks</span><span class="p">.</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="n">self_logs</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">per_batch_losses</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">def</span> <span class="nf">on_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">batch</span><span class="p">,</span><span class="n">logs</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">per_batch_losses</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">logs</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"loss"</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">epoch</span><span class="p">,</span><span class="n">logs</span><span class="p">):</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">per_batch_losses</span><span class="p">)),</span><span class="bp">self</span><span class="p">.</span><span class="n">per_batch_losses</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">"Training loss for each batch"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s">"Batch (epoch</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">per_batch_losses</span> <span class="o">=</span><span class="p">[]</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">model_get_mnist_model</span><span class="p">()</span>
<span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s">"rmsprop"</span><span class="p">,</span>
                <span class="n">loss</span> <span class="o">=</span><span class="s">"sparse_categorical_crossentropy"</span><span class="p">,</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">"accuracy"</span><span class="p">])</span>
<span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_images</span><span class="p">,</span><span class="n">train_labels</span><span class="p">,</span><span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">LossHistory</span><span class="p">()],</span>
            <span class="n">validation_data</span><span class="o">=</span><span class="p">[</span><span class="n">val_images</span><span class="p">,</span><span class="n">val_labels</span><span class="p">])</span>

</code></pre></div></div>


  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="naiborhujosua/mlnotes"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/mlnotes_josua/tensorflow/keras/2022/05/31/tensofrflow-keras.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/mlnotes_josua/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/mlnotes_josua/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/mlnotes_josua/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>My notes about Machine Learning</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/naiborhujosua" target="_blank" title="naiborhujosua"><svg class="svg-icon grey"><use xlink:href="/mlnotes_josua/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/josuanaiborhu" target="_blank" title="josuanaiborhu"><svg class="svg-icon grey"><use xlink:href="/mlnotes_josua/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a rel="me" href="https://twitter.com/naiborhu_josua" target="_blank" title="naiborhu_josua"><svg class="svg-icon grey"><use xlink:href="/mlnotes_josua/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
